---
title: "Comparing Election Resutls - Different Maps"
author: David Gerberry, Xavier University
format:
  html:
    toc: true          # Enable table of contents
    toc-depth: 2 
editor: visual
#editor_options: 
 # chunk_output_type: inline
  
code-fold: true
echo: true
eval: true
warning: false
error: false  
---

# Setup

```{r load-libraries, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(xml2)
library(tidyverse)
library(purrr)
library(sf)
library(RColorBrewer)
library(tidycensus)
library(readxl)
census_api_key("fa67b1dbacf4fbbb1b14c875f34437c6cbdaa694")
```

Load in current election precinct map, old map, and election results

```{r}
# Save dataframe to RDS file
map <- readRDS("map2024.rds")
old.map <- st_zm(st_read("../data/maps/precincts_2020.shp"))

# Load new election results, change correct columns to numeric, 
pres.results.2024 <- read_excel("detail2024.xlsx", sheet = "2",skip=2) %>% 
  mutate(across(c(2:8,45), as.numeric)) %>% 
  select(c(1:8,45)) 

# give useful column names,
colnames(pres.results.2024)<-
  c("Precinct.2024","Registered Voters 2024",
    "Early.Harris.2024","Election.Harris.2024","Total.Harris.2024",
    "Early.Trump.2024","Election.Trump.2024","Total.Trump.2024","Total.2024")
# join election results with map
mapANDresults2024 <-
  left_join(map, pres.results.2024, by = c("PRC_ID_NAME_short" = "Precinct.2024"))

# Load new election results, change correct columns to numeric, 
pres.results.2020 <- read_excel("detail2020.xlsx", sheet = "2",skip=2) %>% 
    mutate(across(c(2:8,33), as.numeric)) %>% 
  select(c(1:8,33))

# give useful column names,
colnames(pres.results.2020)<-
  c("Precinct.2020","Registered Voters 2020",
    "Early.Biden.2020","Election.Biden.2020","Total.Biden.2020",
    "Early.Trump.2020","Election.Trump.2020","Total.Trump.2020","Total.2020")

# join election results with map
mapANDresults2020 <-
  left_join(old.map, pres.results.2020, by = c("PRECINCT" = "Precinct.2020"))
```

Get census population data for interpolating between

```{r get-census, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
block.total <- get_decennial(geography = "block", 
                 state = "Ohio",
                 county = "Hamilton",
                 variables = "P1_001N", 
                 year = 2020,
                 sumfile = "dhc",
                 geometry = TRUE) %>% 
  select(total.pop = value) %>% 
  st_transform(crs = st_crs(map))

## notice how the census blocks are much smaller than voting precincts
block.total %>% ggplot(aes())+ geom_sf()
```

## Interpolating results to different maps

```{r}
# interpolate the 2020 results to the 2024 map
interpolated.results <- interpolate_pw(
  from = st_make_valid(mapANDresults2020),
  to = st_make_valid(map),
  to_id = "PRECINCT",
  extensive = TRUE,
  weights =st_make_valid(block.total),
  weight_column = "total.pop",
  crs = st_crs(map)
) 

# join the 2024 data, so that you have one sf object with a map
# and election results from 2020 and 2024
combined.sf <-
  left_join(interpolated.results, st_drop_geometry(mapANDresults2024), by = c("PRECINCT" = "PRECINCT"))


```

# Using the interpolated data to make comparision

## Trump, 2024 vs Trump, 2020

```{r  fig.width=8, fig.height=4.5}

combined.sf <- combined.sf %>%
  mutate(trump.change = Total.Trump.2024 / Total.2024 - Total.Trump.2020 / Total.2020)
m = min(combined.sf$trump.change, na.rm = TRUE)
M = max(combined.sf$trump.change, na.rm = TRUE)


combined.sf  %>% 
  mutate(trump.change =Total.Trump.2024/Total.2024 - Total.Trump.2020/Total.2020) %>%
  ggplot(aes(fill=trump.change)) +
  geom_sf()+
  labs(title = "Change in Trump support, 2024 vs 2020",
       subtitle = "Trump 2024 (%) - Trump 2020 (%)",
       fill = "", 
       caption = "")+
  scale_fill_gradientn(colours=rev(brewer.pal(n=10,name="RdBu")),
                       values = scales::rescale(c(m,0,M)),
                       na.value = "transparent",
                       breaks=c(.15,.10,0.05,0,-.05,-.10),
                       labels=c("+15%","+10%","+5%","no change","-5%","-10%")
                       )+
  theme_void()



```
